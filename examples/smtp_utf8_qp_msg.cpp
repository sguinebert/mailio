/*

smtp_utf8_qp_msg.cpp
--------------------

Connects to an SMTP server and sends a message with UTF8 content and subject.


Copyright (C) 2025, Sylvain Guinebert (github.com/sguinebert).

Distributed under the FreeBSD license, see the accompanying file LICENSE or
copy at http://www.freebsd.org/copyright/freebsd-license.html.

*/


#include <iostream>
#include <boost/asio.hpp>
#include <boost/asio/co_spawn.hpp>
#include <boost/asio/detached.hpp>
#include <boost/asio/ssl.hpp>
#include <boost/asio/use_awaitable.hpp>
#include <mailio/mime/message.hpp>
#include <mailio/mime/mime.hpp>
#include <mailio/net/tls_mode.hpp>
#include <mailio/smtp/client.hpp>


using mailio::codec;
using mailio::string_t;
using mailio::message;
using mailio::mail_address;
using mailio::mime;
using mailio::smtp::auth_method;
using mailio::smtp::client;
using mailio::smtp::error;
using mailio::net::dialog_error;
using std::cout;
using std::endl;


int main()
{
    boost::asio::io_context io_ctx;
    boost::asio::ssl::context ssl_ctx(boost::asio::ssl::context::tls_client);

    boost::asio::co_spawn(io_ctx,
        [&]() -> boost::asio::awaitable<void>
        {
            try
            {
                // create mail message
                message msg;
                msg.from(mail_address(string_t("mailio library", "ASCII", codec::codec_t::BASE64), "mailio@mailserver.com"));// set the correct sender name and address
                msg.add_recipient(mail_address(string_t("mailio library", "ASCII", codec::codec_t::BASE64), "mailio@gmail.com"));// set the correct recipent name and address
                msg.add_recipient(mail_address(string_t("mailio library", "ASCII", codec::codec_t::BASE64), "mailio@outlook.com"));// add more recipients
                msg.add_cc_recipient(mail_address(string_t("mailio library", "ASCII", codec::codec_t::BASE64), "mailio@yahoo.com"));// add CC recipient
                msg.add_bcc_recipient(mail_address(string_t("mailio library", "ASCII", codec::codec_t::BASE64), "mailio@zoho.com"));

                msg.subject("smtp utf8 quoted printable message");
                // create message in Cyrillic alphabet
                // set Transfer Encoding to Quoted Printable and set Content Type to UTF8
                msg.content_transfer_encoding(mime::content_transfer_encoding_t::QUOTED_PRINTABLE);
                msg.content_type(message::media_type_t::TEXT, "plain", "utf-8");

                msg.content(
                    u8"??? ?? ???? ??????? ?????? ???? ??? ? ??????? ?????? ? ??????????? ??????. ???? ????? ???? ?? ?? ????? ?????????\r\n"
                    u8"?? ?? ????? ?? ?? ?? ???? ????? ????????.\r\n"
                    u8"\r\n"
                    u8"????? ?????? ???? ??????? ???? ???????? ???? ?????, ?? ??\r\n"
                    u8"?????? ???? ???????? ??????????? ?????. ? ????? ? ???? ???????, ??? libmailio ???? ???????? ?? ??\r\n"
                    u8"???? ???????????? ??????.\r\n"
                    u8"\r\n\r\n"
                    u8"? ?????? ???????, ????? ??????? ???????? ????? ??????? ? ??????? utf8 ????????? ???. ????????\r\n"
                    u8"? ?????? ???? ?? ??????? ????? ???? ?? ????????? ??????????. ??????? ?? ?? ?? ??????? ?? ?? ?? ????????\r\n"
                    u8"base64 ??? quoted printable, ??? ?? ascii ????????? ????????? ? ???? ??????. ???? ???? ?? ??????? ??\r\n"
                    u8"?????? ??? ?? ?????? ? ?????? ???????????,\r\n"
                    u8"? ???? ?? ????? ????????? ?? ??????????.\r\n"
                    u8"\r\n\r\n\r\n\r\n"
                    u8"???? ?? ? ??????? ?? ??? ??????? ??????.");

                // connect using STARTTLS
                mailio::smtp::options options;
                options.tls.use_default_verify_paths = true;
                options.tls.verify = mailio::net::verify_mode::peer;
                options.tls.verify_host = true;
                options.auto_starttls = true;

                client conn(io_ctx.get_executor(), options);
                co_await conn.connect("smtp.mailserver.com", "587",
                    mailio::net::tls_mode::starttls, &ssl_ctx, "smtp.mailserver.com");
                // modify username/password to use real credentials
                co_await conn.authenticate("mailio@mailserver.com", "mailiopass", auth_method::login);
                co_await conn.send(msg);
                co_await conn.quit();
            }
            catch (error& exc)
            {
                cout << exc.what() << endl;
            }
            catch (dialog_error& exc)
            {
                cout << exc.what() << endl;
            }
            co_return;
        },
        boost::asio::detached);

    io_ctx.run();
    return EXIT_SUCCESS;
}
